from jmcomic import *
from jmcomic.cl import JmcomicUI

# 下方填入你要下载的本子的id，一行一个，每行的首尾可以有空白字符
jm_albums = '''
  JM1249744
 JM1249731
 JM1249279
 JM1249739
 JM1249282
 JM1249290
JM1249333
 JM1249265
 JM1249195
JM1249728
JM1249198
 JM1249725
JM1249723
JM1249722
JM1249276
JM1249267
JM1249244
 JM1249240
 JM1249241
 JM1249196
 JM1249185
JM1249160
JM1249158
JM1249149
JM1249146
JM1249138
 JM1249063
JM1249061
 JM1249057
 JM1249054
 JM1249050
 JM1249047
JM1249048
 JM1249045
 JM1249041
JM1249035
 JM1249034
JM1249036
JM1249029
 JM1249032
 JM1249028
 JM1249027
JM1249023
JM1249020
 JM1249022
JM1249019
JM1249016
JM1021313
 JM1248981
JM1248889
 JM1248848
 JM1248851
 JM1248845
JM1248827
JM1248819
 JM1248816
JM1248807
 JM1248808
 JM1248803
JM1248804
 JM1248805
 JM1248797
JM1248801
 JM1248802
 JM1248783
JM1248778
JM1248774
JM1248772
 JM1248769
 JM1248770
JM1248764
JM1248761
 JM1248763
 JM1248756
JM1248649
JM1248647
 JM1248646
 JM1248645
JM1248610
 JM1248601
 JM1248567
JM1248563
 JM1248572
JM1248555
 JM1248544
 JM1248536
 JM1248538
 JM1248526
 JM1248531
JM1248524
JM1248522
 JM1248520
 JM1248515
 JM1248509
JM1248501
JM1248493
JM1248491
JM1248483
JM1248480
JM618075
 JM1020687
 JM1248380
JM1248371
JM1241157
JM1059530
 JM1164838
 JM1248278
 JM1248152
 JM1248248
 JM1248249
 JM1248250
JM1248172
 JM1248130
JM1248170
JM1248243
 JM1248174
JM1248158
 JM1248157
JM1086311
JM1248235
JM1248177
JM1248160
JM1248118
 JM1248111
JM1248122
 JM1235104
 JM1195504
 JM1153489
 JM1248076
JM1248039
 JM1248037
JM1248035
JM1248033
JM1248032
 JM1248029
JM1247992
 JM1247724
 JM1247687
 JM1247882
 JM1247879
 JM1247731
 JM1247690
 JM1247723
 JM1247682
 JM1247706
 JM1247866
 JM1247730
 JM1247718
JM1247712
 JM1247702
JM1247710
JM1247709
 JM1247711
 JM1247697
JM1247692
 JM1195674
JM1247691
JM1247859
 JM1247708
 JM1247777
JM1247788
JM1247794
JM1247791
 JM1247790
JM1247786
 JM1247774
JM1247789
 JM1247849
JM1247783
JM1236488
 JM1247646
JM1012940
JM1247586
 JM1247584
JM1247582
 JM1247559
JM1247558
 JM1247552
JM1247557
 JM1241398
 JM1037621
JM1247386
JM1247406
 JM1247395
JM1247397
 JM1247371
 JM1247409
JM1247394
 JM1247537
JM1247505
JM1247361
JM1247358
JM1247343
 JM1247325
 JM1247323
JM1247321
 JM1247318
JM1247314
 JM1247311
 JM1247154
JM1247199
 JM1247109
JM1247153
 JM1247145
JM1247161
JM1246996
 JM1246988
 JM1246995
 JM1247000
 JM1247006
 JM1247220
 JM1247166
 JM1247160
 JM1247147
JM1246880
 JM1246878
 JM1246874
 JM1246954
JM1246945
JM1246915
 JM1246914
JM1246902
 JM1246900
 JM1246905
 JM1246899
 JM1246898
 JM1246894
 JM1246890
 JM1246889
 JM1246888
JM1246886
 JM1246877
JM1246617
 JM1246555
 JM1246542
JM1246535
JM1246528
 JM1246525
 JM1246515
 JM1246500
 JM1246492
JM1246496
 JM1246495
 JM1246488
JM1246477
 JM1246463
JM1246366
JM1246259
 JM1246261
JM1246257
JM1246258
 JM1246255
 JM1246248
JM1246247
 JM1246245
 JM1246243
JM1246238
JM1246234
 JM1246232
 JM1246059
 JM1246227
JM1246222
JM551074
 JM1246054
JM1246051
 JM1246084
 JM1246208
JM1246211
 JM1246089
JM1246204
 JM1246092
JM1246198
 JM1246088
JM1246056
 JM1246058
 JM1246080
 JM1246052
 JM1246049
JM1246048
 JM1245969
 JM1245821
 JM1245837
 JM1245741
JM1245744
 JM1245666
JM1245711
 JM1245616
JM1245517
JM1245493
JM1245343
 JM1245341
JM1245486
JM1245484
 JM1245350
 JM1245450
 JM1245336
 JM1245437
 JM1245427
 JM1245284
JM1243870
 JM1241955
JM1244935
 JM1244942
 JM1244949
 JM551726
JM1243744
JM1245039
 JM1245517
JM1246213
 JM1244380
 JM1244957
 JM1244431
 JM1246556
JM1242980
JM1248266
JM1244003
JM1243160
 JM1242948
 JM1243519
JM1243646
JM1245830
 JM1245074
JM1245663
 JM1244907
JM1248898
JM1244953
JM1248646
JM1243928
 JM1244425
 JM1247541
JM1246554
JM1248540
JM1243528
 JM1242988
 JM1243086
JM1244925
JM1243652
JM1245408
 JM1243874
 JM1243227
 JM1243848
 JM1242938
 JM1243945
JM1245341
 JM1245089
 JM1243654
JM1248515
 JM1246548
 JM1243226
 JM1244110
 JM1242955
 JM1243899
 JM1244771
 JM1246886
 JM1246539
JM1248169
 JM1243895
 JM1243511
JM1241488
 JM1241580
JM1241180
JM1237765
JM1235380
 JM1235031
JM1233741
JM1233703
JM1233727
JM1233462
JM1233548
JM1232351
 JM1232222
 JM1247002
 JM1243916
JM1243007
 JM1242934
JM1241954
 JM1242024
 JM1230131
 JM1229863
JM1229745
 JM1230134
JM1229417
JM1228440
JM1228431
 JM1228599
 JM1227853
 JM1226828
 JM1226068
JM1226532
 JM1225549
 JM1224491
 JM1224368
 JM1222874
 JM1223366
 JM1222506
 JM1221542
 JM1220471
 JM1220587
 JM1220595
 JM1220571
JM1220226
JM1220209
 JM1217792
JM1217798
 JM1217467
 JM1216720
 JM1216452
 JM1215086
 JM1215187
 JM1209873
 JM1209394
 JM1209396
 JM1209392
 JM1193629
 JM1076641
 JM1245650
 JM1227320
 JM648074
JM1202344
JM1117824
 JM611836
 JM1249792
 JM1249730
 JM1248810
 JM1019997
 JM1241693
JM1242947
 JM1242379
 JM1242127
 JM1241779
 JM1241322
 JM1241315
 JM1241228
 JM1240398
JM1240667
 JM1240519
 JM1239715
 JM1239224
 JM1239197
 JM1239122
 JM1239141
 JM1238358
 JM1238371
JM1238350
JM1237970
JM1237904
JM1237236
 JM1243875
JM1228372
JM1160211
JM1071192
 JM1023569
 JM1018595
 JM1018585
 JM499796
 JM1237049
 JM1237042
 JM1235904
 JM1235979
JM1235659
JM1235627
 JM1235472
 JM1235489
 JM1235329
JM1235317
 JM1235403
 JM1233596
 JM1234081
JM1234078
 JM1234079
 JM1233946
 JM1233949
 JM1233557
 JM1233548
 JM1233555
 JM1233529
 JM1233307
 JM1233027
 JM1232509
JM1232422
 JM1232037
 JM1231957
JM1231771
 JM1230984
JM1230612
 JM1230375
 JM1230355
 JM1230057
 JM1230058
 JM1230066
 JM1230049
 JM1230051
 JM1229893
 JM1230018
 JM1229649
 JM1229440
 JM1229356
 JM1229445
 JM1229302
 JM1229333
 JM1228852
 JM1228931
JM1228710
 JM1228564
JM1228451
 JM1228431
JM1228279
 JM1228184
 JM1227844
JM1227855
 JM1227694
 JM1227724
 JM1227680
 JM1227485
 JM1227608
 JM1227374
 JM1226817
 JM1226871
 JM1226767
JM1226740
JM1226726
 JM1226729
 JM1226537
JM1226436
 JM1226098
 JM1226103
 JM1226083
 JM1225818
 JM1225799
 JM1225724
 JM1225329












'''

# 单独下载章节
jm_photos = '''



'''


def env(name, default, trim=('[]', '""', "''")):
    import os
    value = os.getenv(name, None)
    if value is None or value == '':
        return default

    for pair in trim:
        if value.startswith(pair[0]) and value.endswith(pair[1]):
            value = value[1:-1]

    return value


def get_id_set(env_name, given):
    aid_set = set()
    for text in [
        given,
        (env(env_name, '')).replace('-', '\n'),
    ]:
        aid_set.update(str_to_set(text))

    return aid_set


def main():
    album_id_set = get_id_set('JM_ALBUM_IDS', jm_albums)
    photo_id_set = get_id_set('JM_PHOTO_IDS', jm_photos)

    helper = JmcomicUI()
    helper.album_id_list = list(album_id_set)
    helper.photo_id_list = list(photo_id_set)

    option = get_option()
    helper.run(option)
    option.call_all_plugin('after_download')


def get_option():
    # 读取 option 配置文件
    option = create_option(os.path.abspath(os.path.join(__file__, '../../assets/option/option_workflow_download.yml')))

    # 支持工作流覆盖配置文件的配置
    cover_option_config(option)

    # 把请求错误的html下载到文件，方便GitHub Actions下载查看日志
    log_before_raise()

    return option


def cover_option_config(option: JmOption):
    dir_rule = env('DIR_RULE', None)
    if dir_rule is not None:
        the_old = option.dir_rule
        the_new = DirRule(dir_rule, base_dir=the_old.base_dir)
        option.dir_rule = the_new

    impl = env('CLIENT_IMPL', None)
    if impl is not None:
        option.client.impl = impl

    suffix = env('IMAGE_SUFFIX', None)
    if suffix is not None:
        option.download.image.suffix = fix_suffix(suffix)


def log_before_raise():
    jm_download_dir = env('JM_DOWNLOAD_DIR', workspace())
    mkdir_if_not_exists(jm_download_dir)

    def decide_filepath(e):
        resp = e.context.get(ExceptionTool.CONTEXT_KEY_RESP, None)

        if resp is None:
            suffix = str(time_stamp())
        else:
            suffix = resp.url

        name = '-'.join(
            fix_windir_name(it)
            for it in [
                e.description,
                current_thread().name,
                suffix
            ]
        )

        path = f'{jm_download_dir}/【出错了】{name}.log'
        return path

    def exception_listener(e: JmcomicException):
        """
        异常监听器，实现了在 GitHub Actions 下，把请求错误的信息下载到文件，方便调试和通知使用者
        """
        # 决定要写入的文件路径
        path = decide_filepath(e)

        # 准备内容
        content = [
            str(type(e)),
            e.msg,
        ]
        for k, v in e.context.items():
            content.append(f'{k}: {v}')

        # resp.text
        resp = e.context.get(ExceptionTool.CONTEXT_KEY_RESP, None)
        if resp:
            content.append(f'响应文本: {resp.text}')

        # 写文件
        write_text(path, '\n'.join(content))

    JmModuleConfig.register_exception_listener(JmcomicException, exception_listener)


if __name__ == '__main__':
    main()
